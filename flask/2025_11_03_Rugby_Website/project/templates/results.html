{% extends 'base.html' %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='results.css') }}">
{% endblock %}

{% block title %}
Match Results
{% endblock %}

{% block content %}
    <div class="fixture-container"></div>
{% endblock %}

{% block script %}
<script>

let accessLevel = {{ current_user.accessLevel if current_user.accessLevel else 0 }}
function loadLogo(url, element) {
        let img = new Image()
        img.src=url
        img.onload = () => {
            element.src = url
        }
}

async function buildFixtures() {
    const animKey = 'animationLastPlayed'
    const cooldown = 5 * 60 * 1000
    const lastPlayed = parseInt(localStorage.getItem(animKey)) || 0
    const now = Date.now()
    let playAnim

    if (now - lastPlayed < cooldown) {
        playAnim = false
    } else {
        playAnim = true
        localStorage.setItem(animKey, now)
    }
    const response = await fetch('/fixtures/fetch')
    const fixtures = await response.json()
    const container = document.querySelector('.fixture-container')
    const reducedMotion = window.matchMedia(`(prefers-reduced-motion: reduce)`).matches === true
    let animTime = 0.3

    fixtures.forEach((f) => {
        const wrapper = document.createElement('div');
        let isResult = !!f.result
        wrapper.classList.add('fixture-wrapper');
        wrapper.dataset.fixtureId = f.id

        if (!f.result){
            return
        }

        let date = new Date(f.date)

        date=date.toLocaleDateString("en-GB")

        if (accessLevel >= 2){
            wrapper.style.cursor = 'pointer'
        }

        {#wrapper.addEventListener('click', () => createResult(wrapper))#}

        if (!reducedMotion && playAnim) {
            setTimeout(() => {
                wrapper.classList.add('show')
                setTimeout(() => {
                    wrapper.style.transition = 'transform 0.2s'
                }, 600)
            }, animTime * 350)
        } else {
            wrapper.classList.add(`show`)
        }

        const info = document.createElement('div');
        info.classList.add('fixture-info', 'barlow-condensed');
        info.innerHTML = `
            <p style="justify-self: end">${date}</p>
            <p>${f.time}</p>
            <p>${f.venue}</p>
        `;

        const fixture = document.createElement('div');
        fixture.classList.add('fixture');
        if (!isResult) {
            fixture.innerHTML = ``
        } else if (isResult) {
            info.innerHTML = `
            <p style="justify-self: end">${f.date}</p>
            <p>Concluded</p>
            <p>${f.venue}</p>
            `;

            fixture.innerHTML =
            `<div class="team1">
                <h4 class="barlow-condensed">${f.team1.name}</h4>
                <img class="team1-logo" src="static/Placeholder_view_vector.svg">
            </div>

            <p class="middle barlow-condensed" style="justify-self: center">${f.result.team1} - ${f.result.team2}</p>

            <div class="team2">
                <img class="team2-logo" src="static/Placeholder_view_vector.svg">
                <h4 class="barlow-condensed" style="justify-self: end">${f.team2.name}</h4>
            </div>`
            wrapper.classList.add('result')
        }
        wrapper.appendChild(info);
        wrapper.appendChild(fixture);
        container.appendChild(wrapper);
        loadLogo(f.team1.logo, fixture.querySelector('.team1-logo'))
        loadLogo(f.team2.logo, fixture.querySelector('.team2-logo'))
        animTime = animTime + 1
    })
}

document.addEventListener('DOMContentLoaded', buildFixtures)

</script>
{% endblock %}
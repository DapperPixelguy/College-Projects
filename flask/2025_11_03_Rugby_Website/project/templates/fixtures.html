{% extends 'base.html' %}

{% block title %}
Fixtures
{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='fixtures.css') }}">
{% endblock %}

{% block content %}
<div class="fixture-container">
{#{% for item in data %}#}
{#<div class="fixture-wrapper">#}
{#    <div class="fixture-info barlow-condensed">#}
{#        <p style="justify-self: end">{{ item.date }}</p>#}
{#        <p>{{ item.time }}</p>#}
{#        <p>{{ item.venue }}</p>#}
{#    </div>#}
{#    <div class="fixture floatUp">#}
{#        <div class="team1">#}
{#            <h4 class="barlow-condensed">{{ item.team1 }}</h4>#}
{#            <img class="team1-logo" src="{{ url_for('static', filename='daom-rugby.svg') }}">#}
{#        </div>#}
{##}
{#         <p class="middle barlow-condensed" style="justify-self: center">VS</p>#}
{##}
{#        <div class="team2">#}
{#            <img class="team2-logo" src="{{ url_for('static', filename='england-rugby.svg') }}">#}
{#            <h4 class="barlow-condensed" style="justify-self: end">{{ item.team2 }}</h4>#}
{#        </div>#}
{#    </div>#}
{#</div>#}
{#{% endfor %}#}
</div>
{% endblock %}

{% block script %}
<script>

async function createResult(elem) {

    if (!{{ 'true' if current_user.is_authenticated else 'false'}}) {
        return
    }

    if (parseInt({{ current_user.accessLevel }}) < 2) {
    return;
    }


    const id = elem.dataset.fixtureId
    const team1_score = 1
    const team2_score = 2

    const res = await fetch('/fixtures/create-result', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            'id': id,
            'team1_score': team1_score,
            'team2_score': team2_score
        })
    })

    f = await res.json()

    console.log(f)

    let info = elem.querySelector('.fixture-info')
    let fixture = elem.querySelector('.fixture')
    info.innerHTML = `
            <p style="justify-self: end">${f.date}</p>
            <p>Concluded</p>
            <p>${f.venue}</p>
            `;

            fixture.innerHTML =
            `<div class="team1">
                <h4 class="barlow-condensed">${f.team1.name}</h4>
                <img class="team1-logo" src="static/Placeholder_view_vector.svg">
            </div>

            <p class="middle barlow-condensed" style="justify-self: center">${f.team1.score} - ${f.team2.score}</p>

            <div class="team2">
                <img class="team2-logo" src="static/Placeholder_view_vector.svg">
                <h4 class="barlow-condensed" style="justify-self: end">${f.team2.name}</h4>
            </div>`

    data = await res
    console.log(data)

    loadLogo(f.team1.logo, fixture.querySelector('.team1-logo'))
    loadLogo(f.team2.logo, fixture.querySelector('.team2-logo'))

    elem.classList.add('result')
}

function loadLogo(url, element) {
        let img = new Image()
        img.src=url
        img.onload = () => {
            element.src = url
        }
}

async function buildFixtures() {
    const animKey = 'animationLastPlayed'
    const cooldown = 5 * 60 * 1000
    const lastPlayed = parseInt(localStorage.getItem(animKey)) || 0
    const now = Date.now()
    let playAnim

    if (now - lastPlayed < cooldown) {
        playAnim = false
    } else {
        playAnim = true
        localStorage.setItem(animKey, now)
    }
    const response = await fetch('/fixtures/fetch')
    const fixtures = await response.json()
    const container = document.querySelector('.fixture-container')
    const reducedMotion = window.matchMedia(`(prefers-reduced-motion: reduce)`).matches === true
    let animTime = 0.3

    fixtures.forEach((f) => {
        const wrapper = document.createElement('div');
        let isResult = !!f.result
        wrapper.classList.add('fixture-wrapper');
        wrapper.dataset.fixtureId = f.id
        wrapper.addEventListener('click', () => createResult(wrapper))

        if (!reducedMotion && playAnim) {
            setTimeout(() => {
                wrapper.classList.add('show')
                setTimeout(() => {
                    wrapper.style.transition = 'transform 0.2s'
                }, 600)
            }, animTime * 350)
        } else {
            wrapper.classList.add(`show`)
        }

        const info = document.createElement('div');
        info.classList.add('fixture-info', 'barlow-condensed');
        info.innerHTML = `
            <p style="justify-self: end">${f.date}</p>
            <p>${f.time}</p>
            <p>${f.venue}</p>
        `;

        const fixture = document.createElement('div');
        fixture.classList.add('fixture');
        if (!isResult) {
            fixture.innerHTML =
                `<div class="team1">
                <h4 class="barlow-condensed">${f.team1.name}</h4>
                <img class="team1-logo" src="static/Placeholder_view_vector.svg">
            </div>

            <p class="middle barlow-condensed" style="justify-self: center">VS</p>

            <div class="team2">
                <img class="team2-logo" src="static/Placeholder_view_vector.svg">
                <h4 class="barlow-condensed" style="justify-self: end">${f.team2.name}</h4>
            </div>`;
        } else if (isResult) {
            info.innerHTML = `
            <p style="justify-self: end">${f.date}</p>
            <p>Concluded</p>
            <p>${f.venue}</p>
            `;

            fixture.innerHTML =
            `<div class="team1">
                <h4 class="barlow-condensed">${f.team1.name}</h4>
                <img class="team1-logo" src="static/Placeholder_view_vector.svg">
            </div>

            <p class="middle barlow-condensed" style="justify-self: center">${f.result.team1} - ${f.result.team2}</p>

            <div class="team2">
                <img class="team2-logo" src="static/Placeholder_view_vector.svg">
                <h4 class="barlow-condensed" style="justify-self: end">${f.team2.name}</h4>
            </div>`
            wrapper.classList.add('result')
        }
        wrapper.appendChild(info);
        wrapper.appendChild(fixture);
        container.appendChild(wrapper);
        loadLogo(f.team1.logo, fixture.querySelector('.team1-logo'))
        loadLogo(f.team2.logo, fixture.querySelector('.team2-logo'))
        animTime = animTime + 1
    })
}

document.addEventListener('DOMContentLoaded', buildFixtures)

</script>
{% endblock %}
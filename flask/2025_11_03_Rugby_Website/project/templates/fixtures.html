{% extends 'base.html' %}

{% block title %}
Fixtures
{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='fixtures.css') }}">
{% endblock %}

{% block content %}
<div class="fixture-container">
{#{% for item in data %}#}
{#<div class="fixture-wrapper">#}
{#    <div class="fixture-info barlow-condensed">#}
{#        <p style="justify-self: end">{{ item.date }}</p>#}
{#        <p>{{ item.time }}</p>#}
{#        <p>{{ item.venue }}</p>#}
{#    </div>#}
{#    <div class="fixture floatUp">#}
{#        <div class="team1">#}
{#            <h4 class="barlow-condensed">{{ item.team1 }}</h4>#}
{#            <img class="team1-logo" src="{{ url_for('static', filename='daom-rugby.svg') }}">#}
{#        </div>#}
{##}
{#         <p class="middle barlow-condensed" style="justify-self: center">VS</p>#}
{##}
{#        <div class="team2">#}
{#            <img class="team2-logo" src="{{ url_for('static', filename='england-rugby.svg') }}">#}
{#            <h4 class="barlow-condensed" style="justify-self: end">{{ item.team2 }}</h4>#}
{#        </div>#}
{#    </div>#}
{#</div>#}
{#{% endfor %}#}
</div>
{% endblock %}

{% block script %}
<script>
function loadLogo(url, element) {
        let img = new Image()
        img.src=url
        img.onload = () => {
            element.src = url
        }
}

async function buildFixtures() {
    const animKey = 'animationLastPlayed'
    const cooldown = 5 * 60 * 1000
    const lastPlayed = parseInt(localStorage.getItem(animKey)) || 0
    const now = Date.now()
    let playAnim

    if (now - lastPlayed < cooldown) {
        playAnim = false
    } else {
        playAnim = true
        localStorage.setItem(animKey, now)
    }
    const response = await fetch('/fixtures/fetch')
    const fixtures = await response.json()
    const container = document.querySelector('.fixture-container')
    const reducedMotion = window.matchMedia(`(prefers-reduced-motion: reduce)`).matches === true
    let animTime = 0.3

    fixtures.forEach((f) => {
        const wrapper = document.createElement('div');
        wrapper.classList.add('fixture-wrapper');

        if (!reducedMotion && playAnim) {
            setTimeout(() => {
                wrapper.classList.add('show')
                setTimeout(() => {
                    wrapper.style.transition = 'transform 0.2s'
                }, 600)
            }, animTime * 350)
        } else {
            wrapper.classList.add(`show`)
        }

        const info = document.createElement('div');
        info.classList.add('fixture-info', 'barlow-condensed');
        info.innerHTML = `
            <p style="justify-self: end">${f.date}</p>
            <p>${f.time}</p>
            <p>${f.venue}</p>
        `;

        const fixture = document.createElement('div');
        fixture.classList.add('fixture');
        fixture.innerHTML =
            `<div class="team1">
                <h4 class="barlow-condensed">${f.team1.name}</h4>
                <img class="team1-logo" src="static/Placeholder_view_vector.svg">
            </div>

            <p class="middle barlow-condensed" style="justify-self: center">VS</p>

            <div class="team2">
                <img class="team2-logo" src="static/Placeholder_view_vector.svg">
                <h4 class="barlow-condensed" style="justify-self: end">${f.team2.name}</h4>
            </div>`;
        wrapper.appendChild(info);
        wrapper.appendChild(fixture);
        container.appendChild(wrapper);
        loadLogo(f.team1.logo, fixture.querySelector('.team1-logo'))
        loadLogo(f.team2.logo, fixture.querySelector('.team2-logo'))
        animTime = animTime + 1
    })
}

document.addEventListener('DOMContentLoaded', buildFixtures)

</script>
{% endblock %}